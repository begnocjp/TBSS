#!/bin/csh

#################### TBSS script no Top-up ######################

###for running on ACCRE server, may need to first load new version FSL ###############
#module purge
###module load GCC/8.2.0 OpenMPI/3.1.4 FSL/6.0.1-Python-3.7.2 ## load for new 6.0   FSL##
###module load GCC/5.4.0-2.26 OpenMPI/1.10.3 FSL/5.0.10       ## load for old 5.0.1 FSL##
####if fsleyes does not load you can use these to load modules on ACCRE####
#ml GCC/5.4.0-2.26 OpenMPI/1.10.3
#ml FSLeyes/0.15.0         


##### for installing mrtrix3 
#module load GCC/8.2.0 OpenMPI/3.1.4 FSL/6.0.1-Python-3.7.2/SciPy-bundle/2019.03

####check number of diffusion directions for "eddy" tool using MATLAB commands, good minimum #number of direction around 60######
#bvecs = load('bvecs'); % Assuming your filename is bvecs
#figure('position',[100 100 500 500]);
#plot3(bvecs(1,:),bvecs(2,:),bvecs(3,:),'*r');
#axis([-1 1 -1 1 -1 1]);
#axis vis3d;
#rotate3d

#check if "file" exitst in csh#
#test -f "$HARDI_scan" && echo true#####

#step 1 preproc with eddy correct

foreach SUBJECT (6001 6007 6010 6011 6012 6014 6015) 6055: not done 6016: no directory?

setenv SUBJECTS_DIR /gpfs23/scratch/begnocjp/caare_tbss/TAYLOR_CAARE_TBSS

echo $SUBJECT

setenv HARDI_scan $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/NIFTI/701_WIP_HARDI_60_2_5iso.nii.gz

setenv bvecs $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/BVEC/701_WIP_HARDI_60_2_5iso.bvec

setenv bvals $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/BVAL/701_WIP_HARDI_60_2_5iso.bval

setenv mask $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/NIFTI/b0_brain_mask.nii.gz

cd $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/NIFTI/

pwd

###########we have fieldmap, one option might be to use "--field" option when running "eddy" #command (this did not work, might be bc for field option image must be scaled in Hz) for FUGUE #(also for applying a fmap) must know echo time difference, units of field map, and dwell #time)#############

####extract first volume (b0) to create brain mask/"only" brain image #####
#FOREACH $SUBJECT

fslroi $HARDI_scan b0 0 1

####run BET for brain only image and to create mask ######
bet b0 b0_brain -m -f 0.2

setenv mask $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/NIFTI/b0_brain_mask.nii.gz

####check mask#######
##view brain mask overlaid onto original image by first loading the original image into FSLeyes #and then adding the mask image#################

#fsleyes b0 ###then overlay mask####
#fsleyes b0_fmap ###then overlay mask####

###new just "eddy" version### NEED to run FSL FUGUE first if field map is available########


###make acqp and index files if needed, based on phase encoding directions, below is for no phase-#encoding directions#####
setenv acqp /gpfs23/scratch/begnocjp/caare_tbss/acqparams.txt
setenv index /gpfs23/scratch/begnocjp/caare_tbss/index.txt
#touch acqparams.txt #(0 -1 0 .05)
#touch index.txt 

# for index file use sixty-one (# of volumes) ones for all same direction, e.g.: 1 1 1 1 #1 ......x61) can use commands ##to create  use #indx=" " for ((i=1;  i<=61; i+=1)); do indx="$indx #1"; done echo $indx > index.txt

##run new "eddy" correct tool- FSL 6.0 ###
eddy --imain=$HARDI_scan --mask=$mask --index=$index --acqp=$acqp --bvecs=$bvecs --bvals=$bvals --fwhm=0 --flm=quadratic --repol --out=new_eddy_corrected_images

#test eddy tol with within-volume correctio using --mporder option, plus friends, uses slspec file # that needs to know if this was multi-band???#
#touch my_slspec.txt
#eddy --imain=$HARDI_scan --mask=$mask --index=index.txt --acqp=acqparams.txt --bvecs=$bvecs --#bvals=$bvals --niter=8 --fwhm=10,8,4,2,0,0,0,0 --flm=quadratic --repol --mporder=6 --#slspec=my_slspec.txt --s2v_niter=5 --s2v_lambda=1 --s2v_interp=trilinear --#out=new_eddy_corrected_images_2mporder

setenv new_eddy_corrected $SUBJECTS_DIR/$SUBJECT/$SUBJECT"a"/701-x-WIP_HARDI_60_2_5iso-x-WIP_HARDI_60_2_5iso/NIFTI/new_eddy_corrected_images

###calculate tensors and FA map with DTI fit#######
#dtifit -k old_eddy_corrected -o dtifit -m $mask -r $bvecs -b $bvals
dtifit -k $new_eddy_corrected -o dtifit_new_test -m $mask -r $bvecs -b $bvals
#######?????????????????????new eddy only 49 slices processed?????????????????##########

end


### to check load FA map in fsleyes and add V1 image, then click i and change image type to be #diffusion tensor and diplay as RGB modulated by DTI FA########













### fieldmap can improve registration to strucutal image but will not restore lost signal####
##when registering to standard can help to first register to structual####

####register fieldmap to HARDI if using, then make mask from registered image#####
#flirt -in fmap -ref $HARDI_scan -out reg_fmap -omat fmap2HARDI.mat
##epi_reg failed attempt at fixing distortion - eitherway using fmap does not replace lost signal #only helps with registration 
#epi_reg --epi=$HARDI_scan --t1=201_T1W_3D_TFE_SENSE.nii.gz --t1brain=t1_whole_brain --pedir=-y --#out=no_distort_HARDI_4
##FNIRT failed attempt at fixing distortion 
#fnirt --ref=601_Ax-B0map.nii.gz --in=$HARDI_scan --refmask=b0_fmap_brain_mask.nii.gz #iout=no_distort_HARDI_5 aff=fmap2HARDI cout=cout

##BET for T1 if needed##
#bet 201_T1W_3D_TFE_SENSE.nii.gz t1_whole_brain -f .5

#####run old "eddy" correct ("eddy_correct" for older version 5.0.1 FSL, "eddy" is newer 6.0 FSL #version that can incorporate top-up and field map######
###older version###
#eddy_correct $HARDI_scan old_eddy_corrected 0#






